“Clinical Study Ideator & Validator”
A deploy‑ready description you can paste into your engineering ticket or README.md.

1. One‑liner
Generate or vet clinical‑study concepts for a given drug/indication by scraping live evidence with Perplexity’s web‑search API, scoring feasibility & commercial impact, and exporting a full MCDA‑plus‑SWOT report (HTML + PDF/PPTX).

2. Primary user jobs
Job	Trigger	Key outputs
A · “I need fresh study ideas”	chat prompt or /new‑concept REST call	3‑7 concepts each with PICO, MCDA scores, SWOT, cost/timeline/economic card
B · “Validate my synopsis”	file drag‑drop or /validate REST call	Extracted PICO, benchmark deltas, risk flags, revised economics, consolidated SWOT

3. System workflow
mermaid
Copy
Edit
flowchart TD
    subgraph Agent loop
        Q[User input] -->|collect| Parse
        Parse --> Decide
        Decide -->|Needs search| Search[Perplexity API]
        Decide -->|Has file| Extract[Doc → PICO extractor]
        Search --> Vector[Embed & store]
        Extract --> Vector
        Vector --> LLM(OpenAI chat‑completions)
        LLM --> Feasibility(calc module)
        Feasibility --> MCDA
        MCDA --> SWOT
        SWOT --> Report[Report builder]
        Report --> Return
    end
4. External services & credentials
Service	Purpose	ENV var
Perplexity Sonar API 
docs.perplexity.ai
docs.perplexity.ai
Web search (citations included)	PPLX_API_KEY
OpenAI Chat Completions 
docs.perplexity.ai
Generation + reasoning	OPENAI_API_KEY
(optional) Supabase/Postgres	Vector cache (pgvector)	DB_URL, DB_PW

5. Key modules & file map
pgsql
Copy
Edit
/replit-agent
├─ main.py               # entrypoint; Replit Agent interface
├─ inputs.py             # dataclass schemas & validation
├─ search_perplexity.py  # thin wrapper around POST /chat/completions
├─ doc_parse.py          # PDF/DOCX/PPTX → plain text → PICO
├─ mcda.py               # scoring engine + weights json
├─ feasibility.py        # cost, timeline, recruitment calculators
├─ swot.py               # strengths / weaknesses / opportunities / threats generator
├─ report/
│   ├─ html_template.jinja
│   └─ ppt_template.pptx
├─ requirements.txt
└─ README.md             # include this spec
6. Input contract (condensed)
python
Copy
Edit
@dataclass
class GenerateConceptRequest:
    drug_name: str
    indication: str
    strategic_goal: Literal[
        "expand_label", "defend_share", "accelerate_uptake", "real_world_evidence"
    ]
    geography: List[str]          # ISO‑2 codes
    study_phase_pref: Literal["I", "II", "III", "IV", "any"]
    # all below optional:
    current_evidence_refs: List[str] = field(default_factory=list)
    target_subpopulation: Optional[str] = None
    comparator_drugs: List[str] = field(default_factory=list)
    budget_ceiling_eur: Optional[float] = None
    timeline_ceiling_months: Optional[int] = None
    sales_impact_threshold: Optional[float] = None
synopsis_request.py mirrors this but swaps study_document: File.

7. Perplexity search helper (pseudo)
python
Copy
Edit
def web_search(question: str, domains: list[str] | None = None) -> dict:
    headers = {"Authorization": f"Bearer {os.getenv('PPLX_API_KEY')}"}
    payload = {
        "model": "sonar-medium-online",
        "messages": [{"role": "user", "content": question}],
        "web_search_options": {
            "search_context_size": "medium",            # see docs :contentReference[oaicite:2]{index=2}
            "include_citations": True,
            "focus_web_sources": domains or []
        }
    }
    return requests.post("https://api.perplexity.ai/chat/completions",
                         json=payload, headers=headers).json()
Filter domains to ["pubmed.ncbi.nlm.nih.gov","clinicaltrials.gov","nejm.org"] when you want quasi‑PubMed mode.

8. Report builder
Jinja2 → HTML →
  • pdfkit for PDF
  • python-pptx for slide deck (maps each report section to a slide layout)

9. Agent entry (main.py) sketch
python
Copy
Edit
from replit import agent
from inputs import GenerateConceptRequest, SynopsisRequest
from handlers import handle_new_concept, handle_validate

@agent.background
def on_message(msg):
    if msg.path == "/new-concept":
        req = GenerateConceptRequest(**msg.json)
        return handle_new_concept(req)
    elif msg.path == "/validate":
        req = SynopsisRequest(**msg.json, file=msg.file)
        return handle_validate(req)
10. Quick installation notes
bash
Copy
Edit
# .replit
run = "python main.py"

# replit.nix (excerpt)
deps = ["python310", "ffmpeg", "libpq", "openssl", "wkhtmltopdf"]
requirements.txt

shell
Copy
Edit
openai>=1.16
requests
pydantic
jinja2
python-pptx
pdfkit
python-docx
PyPDF2
pandas
tiktoken
11. MVP checklist
Input parsing and schema validation.

Perplexity search wrapper with domain filter + citation capture.

LLM prompt chains for evidence gap, concept generation, synopsis critique.

Static calculators (feasibility.py).

MCDA + SWOT builder with default weights.

HTML/PDF export (skip PPTX if time‑boxed).

Agent routes /new-concept & /validate.

Ship this; iterate toward Monte‑Carlo timelines and fancy slide decks later.

